# Mojo Project Layout

[TOC]

这是 Mojo 程序项目的基本布局。wand 工具自动生成的文件目录结构也是以此为准。

## 介绍

这是一份 Mojo 的项目目录命名规范。本规范较大地参考了 [Standard Go Project Layout](https://github.com/golang-standards/project-layout)。Mojo 语言的一个项目必须是一个完整的包（Package）。

### 概念

- Mojo： Mojo 语言
- Mojo Package： 是 Mojo 语言的一个包，也是 Mojo 项目的最基本单位。
- Mojo API Language：是 Mojo 语言的一个子集，简称 `MAL` 。专门为定义 API 而存在。
- Wand：是Mojo语言的工具集，支持创建Majo Package脚手架，语言编译，构建，包管理系统等等。

### 本文档的约定

本文档所用的需求级别描述词语”MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and “OPTIONAL”在[RFC 2119](https://www.ietf.org/rfc/rfc2119.txt)中有详细描述，在文档中这些关键词使用**粗体**显示。

## Mojo 目录结构

Mojo 目录是Mojo 以及其自动生成的相关文档的目录结构。目录名的命名规范为 `kebab-case` 风格。

### mojo

Mojo Package/ Mojo API 源代码目录。这是需要开发人员初始定义 `API` 的原始mojo代码。mojo目录本身为 `root` 目录，其下面的子目录结构按照package的定义设置相应的目录，即一个目录对应一个package，并把命名风格转换成 `kebab-case` 风格。如果项目的根package为mojo的话，可以省略根目录 (`mojo`)。

例如：`mojo.lang` 包的目录结构就是 `/mojo/lang` 而**不是** `/mojo/mojo/lang`。如: `maps.place` 包的目录结构就是 `/mojo/maps/place` 。

在 `API` 定义过程中，在开发过程中肯定会存在版本的迭代。所以，为了能够隔离不同版本的API，可以将 API 的定义置于一个 `version-tag` 的目录下。而 `version-tag` 的命名规范如下（使用正则表达式）：

```
version-tag:  v[1-9][0-9]*((alpha|beta)[1-9][0-9]*)?
```

例如：上面的例子的 `maps.place`  包的实际目录结构可以是 `/mojo/maps/place/v1` 

### openapi

存放自动生成的 OpenAPI 的 YAML 文件以及 JSON Schema 的 `.schema.json` 文件，其中的目录结构和 mojo 中的目录结构一一对应。Mojo API 中的 `InterfaceDecl` 对应生成符合 [OpenAPI v3.0.3](https://spec.openapis.org/oas/v3.0.3) 版本规范的 YAML 定义文件，而 `StructDecl` 则对应生成符合 [JSON Schema ](https://json-schema.org/specification.html) 的 `.schema.json` 文件。对于 Mojo 中的内嵌的 `StructDecl` ，而其 `Enclosing` 的`StructDecl` 会变成相应的目录。

例如：

在 `mojo.lang` 的 `object_literal_expr.mojo` 中定义：

```
type ObjectLiteralExpr : LiteralExpr {
    type Field {
        name: Expression @1
        value: Expression @2
    }

    fields: [Field] @15
}
```

如果生成对应的 .schema.json 文件，则如下：

```
openapi +
				+-- mojo +
								 +-- lang +
                 					+-- object-literal-expr +
                      														+-- field.schema.json
```

### document

存放自动生成的 Markdown 的说明文档。内部的目录结构与 `openapi` 一一对应。可以理解为 `document` 目录为 openapi 的markdown 形式描述 API 的文档结构。

### protobuf

存放自动生成与 Mojo API 对应的 protobuf 定义文件。内部的目录结构与 mojo 目录结构保持一一对应，在protobuf目录下，对于 mojo 官方 package，并不会省略初始的 mojo 目录，所有的 package 都会和目录一一对应。

例如：

`mojo.lang` 包在 `protobuf` 对应的目录结构为 `/protobuf/mojo/lang`。

### go

存放自动生成 API 对应的 golang 源文件，内部的目录结构遵循 [Standard Go Project Layout](https://github.com/golang-standards/project-layout) 规范。除了自动生成的golang源文件外，API 的开发者也可以增添自有的 API 扩展包，比如为生成的 Struct 增加更加方便的成员函数、构造函数等等。

该目录下也会包含作为完整的 golang 工程的 `go.mod` 等文件。

### go/pkg/{package-name}
存放 API 自动生成以及手工编辑的源代码。`{package-name}` 对应 API 的 `package`，为多级目录。

例如：

`mojo.lang` 包在 `go/pkg` 对应的目录结构为 `/go/pkg/mojo/lang`。

对于不同作用的golang文件会对应不同的后缀名文件，以作区分。

| golang 源文件 | 说明                                                         |
| :------------ | ------------------------------------------------------------ |
| `*.go`        | 手工编辑源代码                                               |
| `*.pb.go`     | 由protoc通过protobuf生成的golang源代码                       |
| `*.json.go`   | 由wand生成或手工编写的 json codec源代码，主要实现自定义的 json 序列化及反序列化 |
| `*.fmt.go`    | 由 wand 生成或手工编写的实现 `Formatter`及` Parser` 接口的源代码，由 `@format` 属性定义的 `StructDecl` |
| `*.ext.go`    | 由 wand 生成或手工编写的扩展函数源代码，主要针对 `Union`、`Boxed<Array<T>>`、`Boxed<Dictionary<Key,Value>>`等类型 |
| `*.sql.go`    | 由 wand 生成或手工编写的 `sql` 模块的 `driver.Valuer` 及 `sql.Scanner` 接口 |

#### 手工编辑与自动生成的覆盖原则

由于在 go/pkg/{package-name} 同时存在自动生成以及手工编写的源代码，所以在自动生成代码并更新的时候，会检测文件是否为自动生成且无法编辑的文件，只有该文件才能被覆盖，其他的文件则会被忽略。

检测方式为：检测源文件的首行字符串是否满足如下的规则（正则表达式）:

```
^//Code generated by .* DO NOT EDIT\.$
```

### java

存放 API 自动生成以及手工编辑的 `JAVA` 源代码

## 服务端应用程序目录
服务端应用程序目录为可选项，一般情况下，建议服务端实现与 API 文件目录使用不同的 git repository 存放，可以方便设置不同的权限管理。如果为了方便将 API 与 实现 置于一个 git repository 时，需要按照如下的目录 layout 规则。

### service-go

当前为基于ncraft-go 的微服务框架实现的业务微服务。内部的目录结构遵循 [Standard Go Project Layout](https://github.com/golang-standards/project-layout) 规范。

### service-java

### service-python
### sidecar

当前为基于ncraft-go 的微服务框架实现的通用的支持多语言的 `sidecar` 服务，可以与 `service-java`， `service-python` 配合，实现多语言统一的微服务体系。

### clients

客户端代码。

- `clients/go`: 存放 `go` 语言的客户端代码，包含 HTTP REST 以及 gRPC 两种客户端
- `clients/java`: 存放 `java` 语言的客户端代码
- `clients/python`: 存放 `python` 语言的客户端代码
- `clients/javascript`: 存放 `JavaScript` 语言的客户端代码
- `clients/{program-language}`: 存放其他语言的客户端代码，语言名对应目录名

## 通用应用程序目录
### build
**打包和持续集成**所需的文件。

- build/ci：存放持续集成的配置和脚本，如果持续集成平台对配置文件有路径要求，则可将其 link 到指定位置。
- build/package：存放 AMI、Docker、系统包（deb、rpm、pkg）的配置和脚本等。

### deployments
IaaS，PaaS，系统和容器编排部署配置和模板（docker-compose，kubernetes/helm，mesos，terraform，bosh）。
### scripts
用于执行各种构建，安装，分析等操作的脚本。

## 其他目录
### assets
项目中使用的其他资源（图像、logo 等）。
### docs
**设计和用户文档**。

### githooks
Git 钩子。
## 其他文件
### Makefile
在任何一个项目中都会存在一些需要运行的脚本，这些脚本文件应该被放到 /scripts 目录中并**由 Makefile 触发**。
